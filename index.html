<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>ReginaéŠè¨˜V14</title>
  
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Confetti -->
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
  <!-- SheetJS -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  
  <!-- React & ReactDOM -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <!-- Babel -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- iOS PWA Settings -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="ReginaéŠè¨˜">
  <meta name="theme-color" content="#FFF0F5">

  <link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100' style='background-color:%23FFF0F5'%3E%3Crect width='100' height='100' fill='%23FFF0F5' rx='30'/%3E%3Ctext x='50' y='50' font-size='50' text-anchor='middle' dy='.35em'%3EğŸŒ¸%3C/text%3E%3Ccircle cx='80' cy='20' r='10' fill='%23FF69B4' stroke='white' stroke-width='2'/%3E%3C/svg%3E">
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100' style='background-color:%23FFF0F5'%3E%3Crect width='100' height='100' fill='%23FFF0F5' rx='30'/%3E%3Ctext x='50' y='50' font-size='50' text-anchor='middle' dy='.35em'%3EğŸŒ¸%3C/text%3E%3Ccircle cx='80' cy='20' r='10' fill='%23FF69B4' stroke='white' stroke-width='2'/%3E%3C/svg%3E">

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Gaegu:wght@300;400;700&family=Hi+Melody&display=swap');
    
    body { font-family: 'Gaegu', cursive; background-color: #FFF0F5; color: #594a4e; -webkit-tap-highlight-color: transparent; overscroll-behavior-y: none; user-select: none; }
    .safe-area-top { padding-top: env(safe-area-inset-top); transition: background-color 0.3s; }
    .safe-area-bottom { padding-bottom: env(safe-area-inset-bottom); background-color: white; }
    
    .app-bg {
      background-color: #FFF0F5;
      background-image: 
        radial-gradient(#FFB6C1 15%, transparent 16%),
        radial-gradient(#ADD8E6 15%, transparent 16%);
      background-size: 20px 20px;
      background-position: 0 0, 10px 10px;
    }
    
    .regina-card {
      background: rgba(255, 255, 255, 0.95);
      border: 2px solid #6B4D57;
      border-radius: 20px;
      box-shadow: 4px 4px 0px #FFB6C1;
      transition: all 0.2s;
      position: relative;
      overflow: hidden;
    }
    .regina-card::before {
      content: ''; position: absolute; top: 0; left: 0; right: 0; height: 6px;
      background: linear-gradient(90deg, #FF9A9E, #FECFEF, #A18CD1, #FBC2EB);
    }
    .regina-card:active { transform: scale(0.98); box-shadow: 2px 2px 0px #FFB6C1; }
    
    .cute-input {
      background: transparent; border: none; outline: none;
      font-family: 'Gaegu', cursive; font-weight: bold; width: 100%;
      color: #594a4e;
    }
    .cute-input::placeholder { color: #594a4e; opacity: 0.4; }

    .no-scrollbar::-webkit-scrollbar { display: none; }
    
    .floating-btn {
      position: fixed; bottom: 100px; right: 24px;
      width: 60px; height: 60px; border-radius: 50%;
      background: #FF69B4; border: 2px solid #fff;
      box-shadow: 0px 4px 10px rgba(255, 105, 180, 0.4);
      display: flex; align-items: center; justify-content: center;
      z-index: 50; transition: all 0.2s; color: white;
    }
    .floating-btn:active { transform: translateY(4px); box-shadow: none; }

    .scan-btn {
      position: fixed; bottom: 170px; right: 24px;
      width: 50px; height: 50px; border-radius: 50%;
      background: #A18CD1; border: 2px solid #fff;
      box-shadow: 0px 4px 10px rgba(161, 140, 209, 0.4);
      display: flex; align-items: center; justify-content: center;
      z-index: 50; transition: all 0.2s; color: white; cursor: pointer;
    }
    .scan-btn:active { transform: translateY(4px); box-shadow: none; }
    
    .fade-slide { animation: fadeSlide 0.3s ease-out; }
    @keyframes fadeSlide { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

    .magic-text {
      background: linear-gradient(45deg, #FF69B4, #A18CD1, #FBC2EB);
      -webkit-background-clip: text; -webkit-text-fill-color: transparent; font-weight: 900;
    }
    
    .shop-tab { flex: 1; text-align: center; padding: 8px; font-weight: bold; border-radius: 12px; transition: all 0.2s; font-size: 14px; }
    .shop-tab.active { background: #FF69B4; color: white; box-shadow: 2px 2px 0px #6B4D57; }
    .shop-tab.active-proxy { background: #87CEEB; color: white; box-shadow: 2px 2px 0px #6B4D57; }
    
    .progress-container { width: 100%; height: 10px; background: #eee; border-radius: 5px; overflow: hidden; border: 1px solid #6B4D57; }
    .progress-fill { height: 100%; background: linear-gradient(90deg, #FF9A9E, #FECFEF); transition: width 0.5s ease; }
  </style>
</head>
<body class="h-screen w-screen overflow-hidden app-bg">
  <div id="root" class="h-full w-full"></div>

  <script type="text/babel">
    const { useState, useEffect, useMemo } = React;

    // --- Icons ---
    const Icon = ({ children, size = 20, className = "" }) => (
      <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round" className={className}>{children}</svg>
    );
    const Icons = {
      Plus: (p) => <Icon {...p}><path d="M5 12h14"/><path d="M12 5v14"/></Icon>,
      Back: (p) => <Icon {...p}><path d="m15 18-6-6 6-6"/></Icon>,
      Home: (p) => <Icon {...p}><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></Icon>,
      Train: (p) => <Icon {...p}><rect width="16" height="16" x="4" y="3" rx="2"/><path d="M4 11h16"/><path d="M12 3v8"/><path d="m8 19-2 3"/><path d="m18 22-2-3"/><path d="M8 15h0"/><path d="M16 15h0"/></Icon>,
      Star: (p) => <Icon {...p}><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></Icon>,
      Food: (p) => <Icon {...p}><path d="M18 8h1a4 4 0 0 1 0 8h-1"/><path d="M2 8h16v9a4 4 0 0 1-4 4H6a4 4 0 0 1-4-4V8z"/><line x1="6" x2="6" y1="1" y2="8"/><line x1="10" x2="10" y1="1" y2="8"/><line x1="14" x2="14" y1="1" y2="8"/></Icon>,
      Wallet: (p) => <Icon {...p}><path d="M21 12V7H5a2 2 0 0 1 0-4h14v4"/><path d="M3 5v14a2 2 0 0 0 2 2h16v-5"/><path d="M18 12a2 2 0 0 0 0 4h4v-4Z"/></Icon>,
      Cross: (p) => <Icon {...p}><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></Icon>,
      Trash: (p) => <Icon {...p}><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></Icon>,
      Download: (p) => <Icon {...p}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></Icon>,
      Settings: (p) => <Icon {...p}><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></Icon>,
      Camera: (p) => <Icon {...p}><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/><circle cx="12" cy="13" r="4"/></Icon>,
      Image: (p) => <Icon {...p}><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></Icon>,
      Magic: (p) => <Icon {...p}><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"/></Icon>,
      Shopping: (p) => <Icon {...p}><path d="M6 2 3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4Z"/><path d="M3 6h18"/><path d="M16 10a4 4 0 0 1-8 0"/></Icon>,
      Share: (p) => <Icon {...p}><circle cx="18" cy="5" r="3"/><circle cx="6" cy="12" r="3"/><circle cx="18" cy="19" r="3"/><line x1="8.59" y1="13.51" x2="15.42" y2="17.49"/><line x1="15.41" y1="6.51" x2="8.59" y2="10.49"/></Icon>,
      Chart: (p) => <Icon {...p}><path d="M3 3v18h18"/><path d="M18 17V9"/><path d="M13 17V5"/><path d="M8 17v-3"/></Icon>,
      MapPin: (p) => <Icon {...p}><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/></Icon>,
      Locate: (p) => <Icon {...p}><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></Icon>,
      Bag: (p) => <Icon {...p}><path d="M6 2 3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4Z"/><line x1="3" y1="6" x2="21" y2="6"/><path d="M16 10a4 4 0 0 1-8 0"/></Icon>,
      Paste: (p) => <Icon {...p}><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/><rect x="8" y="2" width="8" height="4" rx="1" ry="1"/></Icon>
    };

    // --- Configuration ---
    const DEFAULT_PAYMENT = ['ç¾é‡‘', 'ä¿¡ç”¨å¡(ä¸­ä¿¡)', 'ä¿¡ç”¨å¡(å¯Œé‚¦J)', 'ä¿¡ç”¨å¡(åœ‹æ³°Cube)', 'è¥¿ç“œå¡ (Suica)', 'ICOCA', 'PayPay'];
    const DEFAULT_PLATFORM = ['ç¾å ´æ”¯ä»˜', 'Agoda', 'Booking.com', 'Klook', 'KKday', 'Haft (å®˜ç¶²)', 'Rakuten'];
    const CURRENCIES = ['JPY', 'TWD', 'USD', 'KRW', 'EUR'];
    const PRIORITIES = [ 
      { id: 'must', label: 'å¿…è²·', color: '#ff6b6b' }, 
      { id: 'want', label: 'æƒ³è²·', color: '#feca57' }, 
      { id: 'maybe', label: 'çœ‹çœ‹', color: '#1dd1a1' } 
    ];
    const DEFAULT_PACKING = [
      { id: 1, text: 'è­·ç…§ & ç°½è­‰', checked: false },
      { id: 2, text: 'ç¶²å¡ / Wifiæ©Ÿ', checked: false },
      { id: 3, text: 'æ—¥å¹£ç¾éˆ”', checked: false },
      { id: 4, text: 'ä¿¡ç”¨å¡', checked: false },
      { id: 5, text: 'è¡Œå‹•é›»æº', checked: false }
    ];
    
    const INITIAL_TRIP = {
      id: 1, title: '2026 é—œè¥¿èƒèŸ¹æ©«è‘—èµ° ğŸ¦€', startDate: '2026-02-02', days: 10,
      itinerary: [
        { id: 1, date: '2/2', content: 'å¤§é˜ª â†’ 17:00åé–€å¤§æ´‹æ¸¡è¼ª', transport: 'åé–€å¤§æ´‹æ¸¡è¼ª', stay: 'èˆ¹ä¸Šä½å®¿', food: 'èˆ¹ä¸Šè‡ªåŠ©é¤', highlights: 'ç€¨æˆ¶å…§æµ·å¤œæ™¯' },
        { id: 2, date: '2/3', content: 'é–€å¸æ¸¯æ‡·èˆŠå€ â†’ å°å€‰åŸ', transport: 'JRä¹å·', stay: 'ç¦å²¡ Quintessa', food: 'ç‡’å’–å“©', highlights: 'å¾©å¤è»Šç«™æ‹ç…§' },
      ],
      expenses: [],
      shoppingList: [] 
    };

    // --- Charts Component ---
    const PieChart = ({ data }) => {
      const total = data.reduce((acc, item) => acc + item.value, 0);
      let cumulativePercent = 0;
      const getCoordinatesForPercent = (percent) => {
        const x = Math.cos(2 * Math.PI * percent);
        const y = Math.sin(2 * Math.PI * percent);
        return [x, y];
      };
      return (
        <div className="relative w-40 h-40 mx-auto my-4">
          <svg viewBox="-1 -1 2 2" style={{ transform: 'rotate(-90deg)' }}>
            {data.map((slice, i) => {
              if (slice.value === 0) return null;
              const startPercent = cumulativePercent;
              const slicePercent = slice.value / total;
              cumulativePercent += slicePercent;
              const endPercent = cumulativePercent;
              const [startX, startY] = getCoordinatesForPercent(startPercent);
              const [endX, endY] = getCoordinatesForPercent(endPercent);
              const largeArcFlag = slicePercent > 0.5 ? 1 : 0;
              if (slicePercent === 1) return <circle key={i} cx="0" cy="0" r="1" fill={slice.color} />;
              const pathData = `M 0 0 L ${startX} ${startY} A 1 1 0 ${largeArcFlag} 1 ${endX} ${endY} Z`;
              return <path key={i} d={pathData} fill={slice.color} stroke="white" strokeWidth="0.05" />;
            })}
            <circle cx="0" cy="0" r="0.6" fill="white" />
          </svg>
          <div className="absolute inset-0 flex items-center justify-center flex-col pointer-events-none">
             <span className="text-xs font-bold text-gray-400">ç¸½æ”¯å‡º</span>
             <span className="text-sm font-black text-[#6B4D57]">Â¥{total.toLocaleString()}</span>
          </div>
        </div>
      );
    };

    function App() {
      const [trips, setTrips] = useState([]);
      const [settings, setSettings] = useState({ payments: DEFAULT_PAYMENT, platforms: DEFAULT_PLATFORM, packingList: DEFAULT_PACKING });
      const [view, setView] = useState('dashboard');
      const [activeTripId, setActiveTripId] = useState(null);

      // Persistence with fallback
      useEffect(() => {
        try {
          const v14 = localStorage.getItem('regina_trips_v14');
          const v13 = localStorage.getItem('regina_trips_v13');
          const savedTrips = v14 || v13;
          const s11 = localStorage.getItem('regina_settings_v11');
          
          if (savedTrips) setTrips(JSON.parse(savedTrips));
          else setTrips([INITIAL_TRIP]);
          
          if (s11) {
             const s = JSON.parse(s11);
             if(!s.packingList) s.packingList = DEFAULT_PACKING;
             setSettings(s);
          }
        } catch(e) { console.error("Load Error", e); setTrips([INITIAL_TRIP]); }
      }, []);

      useEffect(() => { 
        if (trips.length > 0) localStorage.setItem('regina_trips_v14', JSON.stringify(trips)); 
      }, [trips]);
      
      useEffect(() => { 
        localStorage.setItem('regina_settings_v11', JSON.stringify(settings)); 
      }, [settings]);

      // Actions
      const createTrip = (title, date, days, itineraryData = null) => {
        const newTrip = {
          id: Date.now(), title, startDate: date, days,
          itinerary: itineraryData || Array.from({length: days}, (_, i) => {
             const d = new Date(date); d.setDate(d.getDate() + i);
             return { id: Date.now()+i, date: `${d.getMonth()+1}/${d.getDate()}`, content:'', transport:'', stay:'', food:'', highlights:'', photos: [] };
          }),
          expenses: [],
          shoppingList: []
        };
        setTrips([...trips, newTrip]);
        setView('dashboard');
      };

      const updateTrip = (id, data) => setTrips(trips.map(t => t.id === id ? { ...t, ...data } : t));
      const updateSettings = (key, val) => setSettings({...settings, [key]: val});

      // Excel Export
      const exportExcel = (trip) => {
        if (typeof XLSX === 'undefined') { alert('Excel å…ƒä»¶è¼‰å…¥å¤±æ•—'); return; }
        const wb = XLSX.utils.book_new();
        const summaryData = (trip.expenses || []).map(e => ({ æ—¥æœŸ: e.date, æ™‚é–“: e.time, é …ç›®: e.item, é‡‘é¡: e.amount, å¹£åˆ¥: e.currency, é¡åˆ¥: e.category, æ”¯ä»˜: e.method, å‚™è¨»: e.note }));
        const wsSummary = XLSX.utils.json_to_sheet(summaryData.length ? summaryData : [{å‚™è¨»: "å°šç„¡è³‡æ–™"}]);
        XLSX.utils.book_append_sheet(wb, wsSummary, "ç¸½æ”¯å‡ºæ˜ç´°");
        trip.itinerary.forEach((day, idx) => {
           const dayExpenses = (trip.expenses || []).filter(e => e.date === day.date).map(e => ({ æ™‚é–“: e.time, é …ç›®: e.item, é‡‘é¡: e.amount, å¹£åˆ¥: e.currency, æ”¯ä»˜: e.method, å‚™è¨»: e.note }));
           const dayInfo = [{ æ™‚é–“: 'è¡Œç¨‹', é …ç›®: day.content }, { æ™‚é–“: 'äº¤é€š', é …ç›®: day.transport }, { æ™‚é–“: 'ä½å®¿', é …ç›®: day.stay }, { æ™‚é–“: '--- æ¶ˆè²»æ˜ç´° ---', é …ç›®: '' }];
           XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet([...dayInfo, {}, ...dayExpenses]), `Day${idx+1}`);
        });
        XLSX.writeFile(wb, `${trip.title}_ç´€éŒ„.xlsx`);
      };

      return (
        <div className="h-full w-full">
          {view === 'dashboard' && <Dashboard trips={trips} onCreate={createTrip} onOpen={(id) => { setActiveTripId(id); setView('trip'); }} settings={settings} onUpdateSettings={updateSettings} />}
          {view === 'trip' && activeTripId && <TripContainer trip={trips.find(t => t.id === activeTripId)} onBack={() => setView('dashboard')} onUpdate={(data) => updateTrip(activeTripId, data)} onExport={() => exportExcel(trips.find(t => t.id === activeTripId))} settings={settings} />}
        </div>
      );
    }

    // --- Dashboard ---
    function Dashboard({ trips, onCreate, onOpen, settings, onUpdateSettings }) {
      const [showCreate, setShowCreate] = useState(false);
      const [showSettings, setShowSettings] = useState(false);
      const [showMagic, setShowMagic] = useState(false);
      const [showPacking, setShowPacking] = useState(false);
      const [form, setForm] = useState({ title: '', date: '', days: 5 });

      const togglePacking = (id) => onUpdateSettings('packingList', settings.packingList.map(item => item.id === id ? { ...item, checked: !item.checked } : item));
      const addPacking = () => { const text = prompt('æ–°å¢ç‰©å“ï¼š'); if(text) onUpdateSettings('packingList', [...settings.packingList, { id: Date.now(), text, checked: false }]); };
      const removePacking = (id) => { if(confirm('åˆªé™¤?')) onUpdateSettings('packingList', settings.packingList.filter(item => item.id !== id)); };
      const handleLocate = () => {
        if (!navigator.geolocation) { alert('ä¸æ”¯æ´å®šä½'); return; }
        navigator.geolocation.getCurrentPosition((pos) => { window.open(`https://www.google.com/maps?q=${pos.coords.latitude},${pos.coords.longitude}`, '_blank'); }, () => { alert('ç„¡æ³•å–å¾—ä½ç½®'); });
      };

      return (
        <div className="h-full flex flex-col p-6 app-bg text-[#594a4e] relative overflow-hidden">
          <div className="safe-area-top mb-4"></div>
          <div className="flex justify-between items-center mb-8 relative z-10">
            <div><h1 className="text-3xl font-black tracking-wider magic-text">Regina <br/><span className="text-2xl text-[#594a4e]">èµ°è·³éŠè¨˜</span> ğŸ§­</h1></div>
            <div className="flex gap-2">
               <button onClick={handleLocate} className="p-2 bg-white rounded-full border-2 border-[#6B4D57] shadow-sm"><Icons.MapPin /></button>
               <button onClick={() => setShowSettings(true)} className="p-2 bg-white rounded-full border-2 border-[#6B4D57] shadow-sm"><Icons.Settings /></button>
            </div>
          </div>
          <div className="flex-1 overflow-y-auto space-y-4 no-scrollbar pb-20 relative z-10">
            <div onClick={() => setShowPacking(true)} className="bg-white/80 p-4 rounded-2xl border-2 border-[#6B4D57]/20 flex items-center justify-between cursor-pointer">
               <div className="flex items-center gap-3"><div className="bg-[#FFF0F5] p-2 rounded-full"><Icons.Bag size={20} className="text-[#FF69B4]" /></div><div><h3 className="font-bold">è¡Œææª¢æŸ¥è¡¨</h3><p className="text-xs text-gray-400">å‡ºç™¼å‰åˆ¥å¿˜äº†...</p></div></div>
               <span className="font-bold text-[#FF69B4]">{settings.packingList.filter(i=>i.checked).length}/{settings.packingList.length}</span>
            </div>
            {trips.map(trip => {
               const totalJPY = (trip.expenses||[]).filter(e=>e.currency==='JPY').reduce((a,c)=>a+c.amount,0);
               return (
                <div key={trip.id} onClick={() => onOpen(trip.id)} className="regina-card p-5 cursor-pointer group">
                   <div className="flex justify-between items-start mb-2"><h2 className="text-2xl font-bold">{trip.title}</h2><div className="text-2xl group-hover:scale-125 transition-transform">âœˆï¸</div></div>
                   <p className="font-bold opacity-60 mb-4">{trip.startDate} â€¢ {trip.days} å¤©</p>
                   <div className="flex gap-2"><span className="bg-[#FFF0F5] px-3 py-1 rounded-full text-xs font-bold border border-[#6B4D57]/20 text-[#6B4D57]">æ”¯å‡º: Â¥{totalJPY.toLocaleString()}</span></div>
                </div>
               );
            })}
            <div className="flex gap-3">
                <button onClick={() => setShowCreate(true)} className="flex-1 border-2 border-dashed border-[#6B4D57]/30 rounded-2xl p-6 font-bold text-[#6B4D57]/50 hover:bg-white hover:border-[#FFB6C1] transition-colors flex flex-col items-center gap-2 bg-white/50 backdrop-blur-sm"><Icons.Plus size={24} /> å»ºç«‹</button>
                <button onClick={() => setShowMagic(true)} className="flex-1 bg-gradient-to-br from-[#FFF0F5] to-[#E6E6FA] border-2 border-[#6B4D57]/20 rounded-2xl p-6 font-bold text-[#6B4D57] shadow-sm hover:shadow-md transition-all flex flex-col items-center gap-2"><div className="bg-white p-2 rounded-full shadow-inner"><Icons.Paste size={24} className="text-[#9370DB]" /></div><span className="magic-text text-sm">æ™ºæ…§è§£æ</span></button>
            </div>
          </div>
          {showCreate && <Modal title="æ–°çš„å†’éšªï¼" onClose={() => setShowCreate(false)}><div className="space-y-3"><input className="w-full bg-[#FFF0F5] p-3 rounded-xl font-bold outline-none border-2 border-transparent focus:border-[#FFB6C1]" placeholder="æ—…ç¨‹åç¨±" value={form.title} onChange={e=>setForm({...form, title: e.target.value})} /><div className="flex gap-2"><input type="date" className="w-full bg-[#FFF0F5] p-3 rounded-xl font-bold outline-none" value={form.date} onChange={e=>setForm({...form, date: e.target.value})} /><input type="number" placeholder="å¤©" className="w-20 bg-[#FFF0F5] p-3 rounded-xl font-bold outline-none" value={form.days} onChange={e=>setForm({...form, days: e.target.value})} /></div><button onClick={() => { if(form.title && form.date) { onCreate(form.title, form.date, form.days); setShowCreate(false); } }} className="w-full bg-[#FFB6C1] text-white border-2 border-[#6B4D57] rounded-xl py-3 font-bold mt-2 shadow-[2px_2px_0px_#6B4D57] active:translate-y-1 active:shadow-none transition-all">å‡ºç™¼ï¼</button></div></Modal>}
          {showSettings && <Modal title="è¨­å®šé¸é …" onClose={() => setShowSettings(false)}><div className="space-y-6 max-h-[60vh] overflow-y-auto no-scrollbar"><SettingsList title="ğŸ’³ æ”¯ä»˜æ–¹å¼" items={settings.payments} onUpdate={(items) => onUpdateSettings('payments', items)} /><SettingsList title="ğŸ¨ è¨‚æˆ¿å¹³å°" items={settings.platforms} onUpdate={(items) => onUpdateSettings('platforms', items)} /></div></Modal>}
          {showMagic && <MagicModal onClose={() => setShowMagic(false)} onCreate={onCreate} />}
          {showPacking && <Modal title="ğŸ§³ è¡Œææ¸…å–®" onClose={() => setShowPacking(false)}><div className="max-h-[50vh] overflow-y-auto space-y-2 mb-4">{settings.packingList.map(item => (<div key={item.id} className="flex items-center justify-between bg-[#FFF0F5] p-3 rounded-xl border border-[#FFB6C1]/30"><div className="flex items-center gap-3 cursor-pointer" onClick={() => togglePacking(item.id)}><div className={`w-5 h-5 rounded border-2 border-[#6B4D57] flex items-center justify-center ${item.checked ? 'bg-[#6B4D57] text-white' : 'bg-white'}`}>{item.checked && 'âœ“'}</div><span className={`font-bold ${item.checked ? 'line-through opacity-50' : ''}`}>{item.text}</span></div><button onClick={() => removePacking(item.id)} className="text-red-300 hover:text-red-500"><Icons.Cross size={14}/></button></div>))}</div><button onClick={addPacking} className="w-full border-2 border-dashed border-[#6B4D57]/30 rounded-xl p-3 font-bold text-[#6B4D57]/50">+ æ–°å¢ç‰©å“</button></Modal>}
        </div>
      );
    }

    // --- Smart Parse Helper (No Key) ---
    function MagicModal({ onClose, onCreate }) {
      const [text, setText] = useState('');
      
      const handleParse = () => {
        if(!text) return;
        
        // 1. Try to guess title
        const titleMatch = text.match(/^(.*?)[\n\r]/);
        const title = titleMatch ? titleMatch[1].substring(0, 20) : "åŒ¯å…¥çš„è¡Œç¨‹";
        
        // 2. Try to guess start date (YYYY/MM/DD or MM/DD)
        const dateMatch = text.match(/\d{4}[-/.]\d{1,2}[-/.]\d{1,2}/) || text.match(/\d{1,2}[/-]\d{1,2}/);
        let startDate = new Date().toISOString().split('T')[0];
        if (dateMatch) {
           let dStr = dateMatch[0].replace(/\./g, '-').replace(/\//g, '-');
           if(dStr.length < 6) { // MM-DD
              const year = new Date().getFullYear();
              dStr = `${year}-${dStr}`;
           }
           // Simple validation
           if(!isNaN(new Date(dStr).getTime())) startDate = dStr;
        }

        // 3. Simple Splitting by Date to guess days
        // Look for patterns like "Day 1", "2/2", "2æœˆ2æ—¥"
        const lines = text.split('\n');
        const daysContent = [];
        let currentContent = "";
        
        // Regex for date line start
        const dateLineRegex = /^(\d{1,2}[\/\-]\d{1,2}|Day\s?\d+|ç¬¬\d+å¤©)/i;
        
        lines.forEach(line => {
           if(dateLineRegex.test(line.trim())) {
              if(currentContent) daysContent.push(currentContent);
              currentContent = line + "\n";
           } else {
              currentContent += line + "\n";
           }
        });
        if(currentContent) daysContent.push(currentContent);
        
        const days = Math.max(daysContent.length, 1);
        
        const fullItinerary = Array.from({length: days}, (_, i) => {
           const d = new Date(startDate); d.setDate(new Date(startDate).getDate() + i);
           const content = daysContent[i] || "";
           return { 
             id: Date.now() + i, 
             date: `${d.getMonth()+1}/${d.getDate()}`, 
             content: content.trim(), 
             transport: '', stay: '', food: '', highlights: '', photos: [] 
           };
        });

        onCreate(title, startDate, days, fullItinerary);
        confetti({ particleCount: 150, spread: 80, origin: { y: 0.6 } });
        onClose();
      };

      return (
        <Modal title="ğŸª„ æ™ºæ…§è²¼è²¼åŒ¯å…¥" onClose={onClose}>
           <div className="space-y-4">
             <div className="bg-yellow-50 p-3 rounded-xl text-xs text-[#6B4D57]/80">
               <strong>ğŸ’¡ è°æ˜ç”¨æ³•ï¼š</strong><br/>
               1. å»ç›¸ç°¿æ‰“é–‹è¡Œç¨‹è¡¨ç…§ç‰‡<br/>
               2. é•·æŒ‰è¤‡è£½è£¡é¢çš„æ–‡å­— (æ‰‹æ©Ÿå…§å»ºåŠŸèƒ½)<br/>
               3. è²¼åœ¨ä¸‹é¢ï¼Œæˆ‘å¹«ä½ æ’å¥½ï¼
             </div>
             <textarea 
               className="w-full h-40 bg-[#FFF0F5] p-3 rounded-xl font-bold outline-none text-sm resize-none border-2 border-transparent focus:border-[#FFB6C1]" 
               placeholder="åœ¨æ­¤è²¼ä¸Šè¡Œç¨‹æ–‡å­—..."
               value={text}
               onChange={e => setText(e.target.value)}
             />
             <button onClick={handleParse} className="w-full bg-gradient-to-r from-[#FF9A9E] to-[#FECFEF] text-white font-bold py-3 rounded-2xl shadow-md active:scale-95 transition">
               âœ¨ é–‹å§‹è§£æ
             </button>
           </div>
        </Modal>
      );
    }

    // --- Simple Receipt Parser (No Key) ---
    function ReceiptModal({ onClose, onConfirm }) {
      const [text, setText] = useState('');
      
      const parse = () => {
        // Find biggest number
        const numbers = text.match(/\d{1,3}(,\d{3})*(\.\d+)?/g) || [];
        const cleanNums = numbers.map(n => parseFloat(n.replace(/,/g, ''))).filter(n => !isNaN(n));
        const maxNum = cleanNums.length > 0 ? Math.max(...cleanNums) : '';
        
        onConfirm({
           amount: maxNum,
           item: 'æ”¶æ“šæ¶ˆè²»',
           note: text.substring(0, 50) + (text.length>50?'...':'')
        });
      };

      return (
        <Modal title="ğŸ§¾ æ”¶æ“šè²¼è²¼" onClose={onClose}>
           <div className="space-y-4">
             <div className="bg-blue-50 p-3 rounded-xl text-xs text-[#6B4D57]/80">
               <strong>ğŸ’¡ æ²’ç©ºæ‰“å­—ï¼Ÿ</strong><br/>
               ç”¨æ‰‹æ©Ÿç›¸æ©Ÿæ‹æ”¶æ“š -> è¤‡è£½æ–‡å­— -> è²¼åœ¨ä¸‹é¢<br/>
               æˆ‘å¹«ä½ æŠ“é‡‘é¡ï¼
             </div>
             <textarea 
               className="w-full h-32 bg-[#F0F8FF] p-3 rounded-xl font-bold outline-none text-sm resize-none" 
               placeholder="è²¼ä¸Šæ”¶æ“šæ–‡å­—..."
               value={text}
               onChange={e => setText(e.target.value)}
             />
             <button onClick={parse} className="w-full bg-[#A18CD1] text-white font-bold py-3 rounded-2xl shadow-md active:scale-95 transition">
               ğŸ” æŠ“å–é‡‘é¡
             </button>
           </div>
        </Modal>
      );
    }

    function SettingsList({ title, items, onUpdate }) {
      const [newItem, setNewItem] = useState('');
      const add = () => { if(newItem){ onUpdate([...items, newItem]); setNewItem(''); } };
      const remove = (idx) => { onUpdate(items.filter((_, i) => i !== idx)); };
      return (
        <div>
          <h4 className="font-bold mb-2 text-[#6B4D57]">{title}</h4>
          <div className="flex gap-2 mb-2">
            <input className="flex-1 bg-[#FFF0F5] px-3 rounded-lg font-bold outline-none" value={newItem} onChange={e=>setNewItem(e.target.value)} placeholder="æ–°å¢..." />
            <button onClick={add} className="bg-[#FFB6C1] text-white w-10 h-10 rounded-lg border-2 border-[#6B4D57] flex items-center justify-center shadow-sm"><Icons.Plus size={18}/></button>
          </div>
          <div className="flex flex-wrap gap-2">
            {items.map((item, idx) => (
              <span key={idx} className="bg-white border border-[#FFB6C1] px-3 py-1 rounded-full text-sm font-bold flex gap-2 text-[#6B4D57] shadow-sm">
                {item}
                <button onClick={() => remove(idx)} className="text-red-400 hover:text-red-600"><Icons.Cross size={14}/></button>
              </span>
            ))}
          </div>
        </div>
      );
    }

    function Modal({ title, onClose, children }) {
      return (
        <div className="fixed inset-0 bg-black/30 backdrop-blur-sm flex items-center justify-center p-6 z-50 animate-[fadeSlide_0.2s]">
          <div className="bg-white/95 backdrop-blur border-2 border-[#6B4D57] rounded-3xl p-6 w-full max-w-sm shadow-2xl relative">
            <button onClick={onClose} className="absolute top-4 right-4"><Icons.Cross /></button>
            <h3 className="text-2xl font-black mb-4 text-center text-[#6B4D57]">{title}</h3>
            {children}
          </div>
        </div>
      );
    }

    // --- Container ---
    function TripContainer({ trip, onBack, onUpdate, onExport, settings }) {
      const [tab, setTab] = useState('itinerary'); 
      return (
        <div className="h-full flex flex-col app-bg text-[#594a4e] transition-colors duration-500 relative">
          <div className="safe-area-top bg-[#FFF0F5]"></div>
          <div className="p-4 flex items-center justify-between shadow-sm z-20 bg-[#FFF0F5]/90 backdrop-blur-sm sticky top-0">
            <button onClick={onBack} className="bg-white border-2 border-[#6B4D57] rounded-full p-2 hover:bg-gray-50 transition"><Icons.Back /></button>
            <h2 className="font-black text-lg truncate max-w-[150px]">{trip.title}</h2>
            <button onClick={onExport} className="bg-[#207245] text-white rounded-full px-3 py-1 text-xs font-bold shadow-md hover:bg-[#185c37] flex items-center gap-1">Excel <Icons.Download size={14}/></button>
          </div>
          <div className="flex-1 overflow-hidden relative">
            {tab === 'itinerary' && <ItineraryView trip={trip} onUpdate={onUpdate} settings={settings} />}
            {tab === 'shopping' && <ShoppingView trip={trip} onUpdate={onUpdate} settings={settings} />}
            {tab === 'stats' && <StatsView trip={trip} />}
          </div>
          <div className="safe-area-bottom bg-white border-t-2 border-[#FFB6C1] p-2 flex justify-around shadow-[0_-4px_10px_rgba(255,182,193,0.2)] z-30">
            <button onClick={() => setTab('itinerary')} className={`flex flex-col items-center p-2 rounded-xl w-20 transition-all ${tab === 'itinerary' ? 'text-[#FF69B4] -translate-y-1' : 'text-gray-400'}`}><Icons.Home size={24} /><span className="text-xs font-bold">è¡Œç¨‹</span></button>
            <button onClick={() => setTab('shopping')} className={`flex flex-col items-center p-2 rounded-xl w-20 transition-all ${tab === 'shopping' ? 'text-[#FF69B4] -translate-y-1' : 'text-gray-400'}`}><Icons.Shopping size={24} /><span className="text-xs font-bold">è³¼ç‰©</span></button>
            <button onClick={() => setTab('stats')} className={`flex flex-col items-center p-2 rounded-xl w-20 transition-all ${tab === 'stats' ? 'text-[#FF69B4] -translate-y-1' : 'text-gray-400'}`}><Icons.Chart size={24} /><span className="text-xs font-bold">çµ±è¨ˆ</span></button>
          </div>
        </div>
      );
    }

    // --- Stats View (Same as V11) ---
    function StatsView({ trip }) {
      const expenses = trip.expenses || [];
      const totalJPY = expenses.filter(e => e.currency === 'JPY').reduce((acc, curr) => acc + curr.amount, 0);
      const catData = ['é£²é£Ÿ', 'äº¤é€š', 'ä½å®¿', 'è³¼ç‰©', 'é–€ç¥¨', 'å…¶ä»–'].map(cat => ({ label: cat, value: expenses.filter(e => e.category === cat && e.currency === 'JPY').reduce((a,c) => a + c.amount, 0), color: { 'é£²é£Ÿ': '#FF9F43', 'äº¤é€š': '#54a0ff', 'ä½å®¿': '#5f27cd', 'è³¼ç‰©': '#ff6b81', 'é–€ç¥¨': '#1dd1a1', 'å…¶ä»–': '#8395a7' }[cat] })).filter(d => d.value > 0);
      const dayData = trip.itinerary.map(day => ({ date: day.date, value: expenses.filter(e => e.date === day.date && e.currency === 'JPY').reduce((a,c) => a+c.amount, 0) }));
      const maxDayVal = Math.max(...dayData.map(d => d.value), 1);
      const methodData = Object.entries(expenses.reduce((acc, curr) => { if(curr.currency === 'JPY') acc[curr.method] = (acc[curr.method] || 0) + curr.amount; return acc; }, {})).map(([k, v]) => ({ label: k, value: v }));

      return (
        <div className="h-full overflow-y-auto p-4 space-y-4 no-scrollbar pb-24">
          <div className="regina-card p-4 bg-white text-center"><h3 className="font-bold text-[#6B4D57] opacity-60 mb-2">ç¸½æ”¯å‡º (æ—¥åœ“)</h3><PieChart data={catData} /><div className="grid grid-cols-2 gap-2 text-left mt-4">{catData.map(d => (<div key={d.label} className="flex items-center gap-2 text-xs font-bold"><span className="w-3 h-3 rounded-full" style={{background: d.color}}></span><span>{d.label}</span><span className="ml-auto text-gray-500">Â¥{d.value.toLocaleString()}</span></div>))}</div></div>
          <div className="regina-card p-4 bg-white"><h3 className="font-bold text-[#6B4D57] opacity-60 mb-4">æ¯æ—¥è¶¨å‹¢</h3><div className="flex items-end gap-2 h-32 overflow-x-auto no-scrollbar pb-2">{dayData.map((d, i) => (<div key={i} className="flex flex-col items-center flex-1 min-w-[30px]"><div className="w-full bg-[#FFB6C1] rounded-t-md transition-all relative group" style={{height: `${(d.value/maxDayVal)*100}%`}}></div><span className="text-[10px] text-gray-400 mt-1">{d.date.split('/')[1]}</span></div>))}</div></div>
          <div className="regina-card p-4 bg-white"><h3 className="font-bold text-[#6B4D57] opacity-60 mb-2">æ”¯ä»˜å æ¯”</h3>{methodData.map(d => (<div key={d.label} className="mb-2"><div className="flex justify-between text-xs font-bold mb-1"><span>{d.label}</span><span>Â¥{d.value.toLocaleString()}</span></div><div className="w-full bg-gray-100 rounded-full h-2"><div className="bg-[#AEC6CF] h-2 rounded-full" style={{width: `${(d.value/totalJPY)*100}%`}}></div></div></div>))}</div>
        </div>
      );
    }

    // --- Itinerary View ---
    function ItineraryView({ trip, onUpdate, settings }) {
      const [dayIdx, setDayIdx] = useState(0);
      const [showExpModal, setShowExpModal] = useState(false);
      const [showReceipt, setShowReceipt] = useState(false);
      const [expForm, setExpForm] = useState({ item: '', amount: '', currency: 'JPY', method: settings.payments[0], platform: 'ç¾å ´æ”¯ä»˜', note: '', time: '' });

      const day = trip.itinerary[dayIdx];
      const dayExpenses = (trip.expenses || []).filter(e => e.date === day.date);
      const dayTotalJPY = dayExpenses.filter(e=>e.currency==='JPY').reduce((a,c) => a + c.amount, 0);
      const paymentStats = useMemo(() => { const s={}; (trip.expenses||[]).forEach(e=>{ if(!s[e.method])s[e.method]=0; if(e.currency==='JPY')s[e.method]+=e.amount; }); return s; }, [trip.expenses]);
      const THEME_COLORS = [{ bg: '#FFD1DC', border: '#FF69B4' }, { bg: '#AEC6CF', border: '#5F9EA0' }, { bg: '#FDFD96', border: '#DAA520' }, { bg: '#B19CD9', border: '#9370DB' }];
      
      const updateDay = (field, val) => { const newItin = [...trip.itinerary]; newItin[dayIdx] = { ...newItin[dayIdx], [field]: val }; onUpdate({ itinerary: newItin }); };
      
      const handlePhotoUpload = (e) => {
        const file = e.target.files[0]; if(!file)return;
        const reader=new FileReader(); reader.onload=(ev)=>{const img=new Image();img.onload=()=>{const cvs=document.createElement('canvas');const ctx=cvs.getContext('2d');let w=img.width,h=img.height;const MAX=800;if(w>h){if(w>MAX){h*=MAX/w;w=MAX}}else{if(h>MAX){w*=MAX/h;h=MAX}}cvs.width=w;cvs.height=h;ctx.drawImage(img,0,0,w,h);updateDay('photos',[...(day.photos||[]),cvs.toDataURL('image/jpeg',0.7)])};img.src=ev.target.result};reader.readAsDataURL(file);
      };
      const removePhoto = (idx) => { if(confirm('åˆªé™¤?')) updateDay('photos', (day.photos || []).filter((_, i) => i !== idx)); };

      const openAdd = (overrides = {}) => {
        const now = new Date();
        const timeStr = `${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`;
        setExpForm({ ...expForm, item:'', amount:'', note:'', time: timeStr, ...overrides });
        setShowExpModal(true);
      };

      const handleReceiptData = (data) => {
        setShowReceipt(false);
        openAdd({ item: data.item, amount: data.amount, note: data.note });
      };

      const addExpense = () => { 
        if(expForm.item&&expForm.amount){ 
          onUpdate({ expenses: [...trip.expenses, { id: Date.now(), date: day.date, item: expForm.item, amount: parseFloat(expForm.amount), currency: expForm.currency, category: 'ä¸€èˆ¬', method: expForm.method, platform: expForm.platform, note: expForm.note, time: expForm.time }] }); 
          setShowExpModal(false); 
        } 
      };
      const deleteExpense = (id) => { if(confirm('åˆªé™¤?')) onUpdate({ expenses: trip.expenses.filter(e => e.id !== id) }); };
      const openMap = (query) => { if(!query) return; window.open(`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(query)}`, '_blank'); };

      return (
        <div className="h-full flex flex-col">
          <div className="pb-2 px-4 overflow-x-auto whitespace-nowrap no-scrollbar flex gap-2 snap-x pt-2 shrink-0">
            {trip.itinerary.map((d, i) => (
              <button key={d.id} onClick={() => setDayIdx(i)} className={`snap-center inline-flex flex-col items-center justify-center w-16 h-20 rounded-2xl border-2 transition-all relative ${i === dayIdx ? 'shadow-md -translate-y-1 bg-white' : 'bg-white/50 border-transparent scale-90'}`} style={{ borderColor: i === dayIdx ? THEME_COLORS[i%4].border : 'transparent' }}>
                {i === dayIdx && <div className="absolute -top-3 w-8 h-8 rounded-full z-[-1]" style={{background: THEME_COLORS[i%4].bg}}></div>}
                <span className="text-xs font-bold opacity-60">Day {i+1}</span><span className="text-lg font-black">{d.date}</span>
              </button>
            ))}
          </div>
          <div className="flex-1 overflow-y-auto p-4 pb-24 space-y-4 no-scrollbar">
            <div className="regina-card p-4 fade-slide bg-[#FFF0F5]"><div className="flex justify-between items-end mb-2"><span className="text-xs font-bold opacity-50">ä»Šæ—¥èŠ±è²» (JPY)</span><span className="text-3xl font-black text-[#6B4D57]">Â¥{dayTotalJPY.toLocaleString()}</span></div><div className="h-[1px] bg-[#6B4D57]/20 mb-2"></div><div className="flex gap-2 overflow-x-auto no-scrollbar">{Object.entries(paymentStats).map(([method, amt]) => amt > 0 && (<span key={method} className="text-[10px] bg-white px-2 py-1 rounded border border-[#6B4D57]/10 whitespace-nowrap">{method}: Â¥{amt.toLocaleString()}</span>))}</div></div>
            <div className="regina-card p-4 fade-slide" style={{animationDelay: '0.05s'}}><div className="flex justify-between items-center mb-3"><div className="flex items-center gap-2 text-[#6B4D57]"><Icons.Image size={18} /> <span className="font-bold">è¡Œç¨‹å¿«ç…§</span></div><label className="bg-[#FFF0F5] px-3 py-1 rounded-full text-xs font-bold border border-[#6B4D57] flex items-center gap-1 cursor-pointer active:scale-95 transition"><Icons.Camera size={14} /> æ‹ç…§<input type="file" accept="image/*" capture="environment" className="hidden" onChange={handlePhotoUpload} /></label></div>{(day.photos || []).length === 0 ? <div className="h-24 border-2 border-dashed border-[#6B4D57]/20 rounded-xl flex flex-col items-center justify-center text-[#6B4D57]/30 text-sm font-bold bg-white/50"><span className="text-2xl mb-1">ğŸ“¸</span>æ‹ä¸‹èœå–®æˆ–æ™‚åˆ»è¡¨å§</div> : <div className="flex gap-2 overflow-x-auto pb-2 no-scrollbar">{day.photos.map((photo, idx) => (<div key={idx} className="relative shrink-0 w-32 h-32 rounded-xl overflow-hidden border-2 border-[#6B4D57] shadow-sm group"><img src={photo} className="w-full h-full object-cover" /><button onClick={() => removePhoto(idx)} className="absolute top-1 right-1 bg-red-400 text-white rounded-full p-1 shadow opacity-0 group-hover:opacity-100 transition"><Icons.Cross size={12}/></button></div>))}</div>}</div>
            <div className="regina-card p-4 fade-slide" style={{animationDelay: '0.1s'}}><div className="flex justify-between items-center mb-2 text-[#E6B325]"><div className="flex items-center gap-2"><Icons.Home size={18} /> <span className="font-bold">ä»Šæ—¥è¡Œç¨‹</span></div><button onClick={() => openMap(day.content)} className="text-[#6B4D57]/50 hover:text-[#6B4D57]"><Icons.MapPin size={16}/></button></div><textarea className="cute-input text-lg resize-none h-20" placeholder="ä»Šå¤©è¦å»åšä»€éº¼å‘¢..." value={day.content} onChange={e => updateDay('content', e.target.value)} /></div>
            <div className="grid grid-cols-2 gap-3 fade-slide" style={{animationDelay: '0.15s'}}><div className="regina-card p-3"><div className="flex justify-between mb-1 text-[#547C96] text-sm font-bold"><div className="flex gap-1"><Icons.Train size={16} /> äº¤é€š</div><button onClick={() => openMap(day.transport)}><Icons.MapPin size={14}/></button></div><input className="cute-input text-sm" placeholder="ç§»å‹•æ–¹å¼" value={day.transport} onChange={e => updateDay('transport', e.target.value)} /></div><div className="regina-card p-3"><div className="flex justify-between mb-1 text-[#D65F7A] text-sm font-bold"><div className="flex gap-1"><Icons.Star size={16} /> äº®é»</div><button onClick={() => openMap(day.highlights)}><Icons.MapPin size={14}/></button></div><input className="cute-input text-sm" placeholder="å¿…çœ‹å¿…ç©" value={day.highlights} onChange={e => updateDay('highlights', e.target.value)} /></div></div>
            <div className="regina-card p-4 fade-slide" style={{animationDelay: '0.2s'}}><div className="flex justify-between items-center mb-2 text-[#FF8DA1]"><div className="flex items-center gap-2"><Icons.Food size={18} /> <span className="font-bold">å¥½åƒçš„</span></div><button onClick={() => openMap(day.food)} className="text-[#6B4D57]/50 hover:text-[#6B4D57]"><Icons.MapPin size={16}/></button></div><textarea className="cute-input text-md resize-none h-16" placeholder="åˆé¤ã€æ™šé¤ã€é»å¿ƒ..." value={day.food} onChange={e => updateDay('food', e.target.value)} /></div>
            {dayExpenses.length > 0 && <div className="space-y-2 pt-2 fade-slide"><div className="text-xs font-bold opacity-40 ml-2">ä»Šæ—¥æ˜ç´°</div>{dayExpenses.map(e => (<div key={e.id} className="bg-white/80 border border-[#6B4D57]/10 rounded-xl p-3 flex justify-between items-center shadow-sm"><div><div className="flex items-center gap-2"><span className="text-[10px] text-[#6B4D57] bg-gray-100 px-1 rounded">{e.time}</span><span className="font-bold">{e.item}</span></div><div className="flex gap-1 mt-1"><span className="text-[10px] text-[#6B4D57] bg-[#FFF0F5] px-2 py-0.5 rounded-full border border-[#FFB6C1]/50">{e.method}</span>{e.note && <span className="text-[10px] text-gray-400">({e.note})</span>}</div></div><div className="flex items-center gap-3"><span className="font-black opacity-60 text-sm">{e.currency} {e.amount}</span><button onClick={() => deleteExpense(e.id)} className="opacity-20 hover:opacity-100 hover:text-red-400"><Icons.Trash size={14}/></button></div></div>))}</div>}
          </div>
          <button onClick={() => setShowReceipt(true)} className="scan-btn animate-[bounce_2s_infinite] shadow-lg"><span className="text-xl">ğŸ§¾</span></button>
          <button onClick={() => openAdd()} className="floating-btn shadow-lg"><Icons.Wallet size={28} /></button>
          {showExpModal && <div className="fixed inset-0 bg-black/20 backdrop-blur-sm z-50 flex items-end justify-center sm:items-center"><div className="bg-white w-full max-w-sm rounded-t-3xl sm:rounded-3xl p-6 border-t-2 sm:border-2 border-[#6B4D57] shadow-2xl animate-[fadeSlide_0.3s]"><div className="flex justify-between items-center mb-4"><h3 className="font-bold text-xl">è¨˜ä¸€ç­† ({day.date})</h3><button onClick={() => setShowExpModal(false)}><Icons.Cross /></button></div><div className="space-y-3"><input autoFocus placeholder="è²·äº†ä»€éº¼ï¼Ÿ" className="w-full bg-[#FFF0F5] p-3 rounded-xl font-bold outline-none text-lg" value={expForm.item} onChange={e=>setExpForm({...expForm, item: e.target.value})} /><div className="flex gap-2"><select className="w-24 bg-[#FFF0F5] p-3 rounded-xl font-bold outline-none text-center" value={expForm.currency} onChange={e=>setExpForm({...expForm, currency: e.target.value})}>{CURRENCIES.map(c=><option key={c} value={c}>{c}</option>)}</select><input type="number" placeholder="é‡‘é¡" className="flex-1 bg-[#FFF0F5] p-3 rounded-xl font-black outline-none text-2xl" value={expForm.amount} onChange={e=>setExpForm({...expForm, amount: e.target.value})} /></div><div className="grid grid-cols-2 gap-2"><div><label className="text-xs font-bold opacity-50 ml-1">æ”¯ä»˜</label><select className="w-full bg-[#FFF0F5] p-2 rounded-xl font-bold text-sm outline-none text-[#6B4D57]" value={expForm.method} onChange={e=>setExpForm({...expForm, method: e.target.value})}>{settings.payments.map(m => <option key={m} value={m}>{m}</option>)}</select></div><div><label className="text-xs font-bold opacity-50 ml-1">æ™‚é–“</label><input type="time" className="w-full bg-[#FFF0F5] p-2 rounded-xl font-bold text-sm outline-none text-[#6B4D57]" value={expForm.time} onChange={e=>setExpForm({...expForm, time: e.target.value})} /></div></div><div className="grid grid-cols-2 gap-2"><div><label className="text-xs font-bold opacity-50 ml-1">é¡åˆ¥</label><select className="w-full bg-[#FFF0F5] p-2 rounded-xl font-bold text-sm outline-none text-[#6B4D57]" value={expForm.category} onChange={e=>setExpForm({...expForm, category: e.target.value})}>{['é£²é£Ÿ','äº¤é€š','ä½å®¿','è³¼ç‰©','é–€ç¥¨','å…¶ä»–'].map(c=><option key={c} value={c}>{c}</option>)}</select></div></div><input placeholder="å‚™è¨»..." className="w-full bg-[#FFF0F5] p-2 rounded-xl text-sm outline-none" value={expForm.note} onChange={e=>setExpForm({...expForm, note: e.target.value})} /><button onClick={addExpense} className="w-full bg-[#FF69B4] text-white border-2 border-[#6B4D57] rounded-xl py-3 font-bold mt-2 shadow-[2px_2px_0px_#6B4D57] active:translate-y-1 active:shadow-none transition-all">è¨˜ä¸‹ä¾†ï¼</button></div></div></div>}
          {showReceipt && <ReceiptModal onClose={() => setShowReceipt(false)} onConfirm={handleReceiptData} />}
        </div>
      );
    }

    // --- Shopping View (Same as V9.1) ---
    function ShoppingView({ trip, onUpdate }) {
      const [type, setType] = useState('self'); const [newItem, setNewItem] = useState(''); const [newPrice, setNewPrice] = useState(''); const [newPriority, setNewPriority] = useState('must'); const [newNote, setNewNote] = useState('');
      const list = (trip.shoppingList || []).filter(i => i.type === type);
      const sortedList = [...list].sort((a, b) => (a.bought === b.bought ? ({ 'must': 0, 'want': 1, 'maybe': 2 }[a.priority] - { 'must': 0, 'want': 1, 'maybe': 2 }[b.priority]) : (a.bought ? 1 : -1)));
      const boughtCount = list.filter(i => i.bought).length; const progress = list.length > 0 ? (boughtCount / list.length) * 100 : 0;
      const addItem = () => { if(!newItem) return; onUpdate({ shoppingList: [...(trip.shoppingList || []), { id: Date.now(), name: newItem, price: newPrice, priority: newPriority, type, note: newNote, bought: false }] }); setNewItem(''); setNewPrice(''); setNewNote(''); };
      const toggleBuy = (id) => onUpdate({ shoppingList: trip.shoppingList.map(i => i.id === id ? { ...i, bought: !i.bought } : i) });
      const deleteItem = (id) => { if(confirm('åˆªé™¤?')) onUpdate({ shoppingList: trip.shoppingList.filter(i => i.id !== id) }); };
      const shareLine = () => { let text = `ğŸ›ï¸ ${type==='self'?'è‡ªç”¨':'ä»£è³¼'}æ¸…å–®ï¼š\n`; sortedList.filter(i => !i.bought).forEach(i => text += `${i.priority==='must'?'ğŸ”´':i.priority==='want'?'ğŸŸ¡':'ğŸŸ¢'} ${i.name} ${i.price?`(Â¥${i.price})`:''} ${i.note?`[${i.note}]`:''}\n`); window.open('https://line.me/R/msg/text/?' + encodeURIComponent(text)); };
      const convertToExpense = (item) => { const cost = prompt(`é‡‘é¡ (æ—¥å¹£):`, item.price || ''); if(cost) { onUpdate({ expenses: [...trip.expenses, { id: Date.now(), date: trip.itinerary[0].date, item: item.name + (item.note ? ` (${item.note})` : ''), amount: parseFloat(cost), currency: 'JPY', category: 'è³¼ç‰©', method: 'ç¾é‡‘', platform: 'ç¾å ´æ”¯ä»˜', time: '12:00' }], shoppingList: trip.shoppingList.map(i => i.id === item.id ? { ...i, bought: true } : i) }); alert('å·²è½‰å…¥è¨˜å¸³ï¼'); } };
      return (
        <div className="h-full flex flex-col"><div className="p-4 bg-[#FFF0F5]"><div className="flex rounded-2xl bg-white p-1 border-2 border-[#6B4D57] mb-3"><button onClick={() => setType('self')} className={`shop-tab ${type === 'self' ? 'active' : ''}`}>ğŸ™‹â€â™€ï¸ è‡ªç”¨</button><button onClick={() => setType('proxy')} className={`shop-tab ${type === 'proxy' ? 'active' : ''}`}>ğŸ¤ ä»£è³¼</button></div><div className="flex items-center gap-2 mb-1"><div className="progress-container flex-1"><div className="progress-fill" style={{width: `${progress}%`}}></div></div><span className="text-xs font-bold text-[#6B4D57]">{boughtCount}/{list.length}</span></div></div><div className="flex-1 overflow-y-auto p-4 pt-0 pb-24 space-y-4 no-scrollbar"><div className={`regina-card p-4 border-t-4 ${type==='self'?'border-t-[#FF69B4]':'border-t-[#87CEEB]'}`}><div className="flex flex-col gap-2"><input className="cute-input text-lg border-b border-[#FFB6C1]" placeholder="æƒ³è²·ä»€éº¼..." value={newItem} onChange={e=>setNewItem(e.target.value)} /><div className="flex gap-2"><select className="bg-[#FFF0F5] rounded-lg text-xs font-bold p-1 outline-none" value={newPriority} onChange={e=>setNewPriority(e.target.value)}>{PRIORITIES.map(p=><option key={p.id} value={p.id}>{p.label}</option>)}</select><input className="cute-input w-20 border-b border-[#FFB6C1]" type="number" placeholder="Â¥é ç®—" value={newPrice} onChange={e=>setNewPrice(e.target.value)} /><input className="cute-input border-b border-[#FFB6C1]" placeholder={type==='self'?'å•†åº—?':'èª°çš„?'} value={newNote} onChange={e=>setNewNote(e.target.value)} /></div><button onClick={addItem} className={`w-full py-2 rounded-xl text-white font-bold mt-2 shadow-sm active:translate-y-1 transition-all ${type==='self'?'bg-[#FF69B4]':'bg-[#87CEEB]'}`}>åŠ å…¥æ¸…å–®</button></div></div><div className="flex justify-end"><button onClick={shareLine} className="bg-[#06C755] text-white text-xs px-3 py-1 rounded-full font-bold flex items-center gap-1 shadow-sm active:scale-95"><Icons.Share size={12}/> Line</button></div><div className="space-y-2">{sortedList.map(item => (<div key={item.id} className={`bg-white border-2 border-[#6B4D57] rounded-xl p-3 flex justify-between items-center shadow-[3px_3px_0px_#eee] ${item.bought ? 'opacity-50 grayscale' : ''}`}><div className="flex items-center gap-3"><button onClick={() => toggleBuy(item.id)} className={`w-6 h-6 rounded-full border-2 border-[#6B4D57] flex items-center justify-center ${item.bought?'bg-[#6B4D57] text-white':''}`}>{item.bought && 'âœ“'}</button><div><div className="flex items-center gap-1"><span className={`w-2 h-2 rounded-full`} style={{background: PRIORITIES.find(p=>p.id===item.priority).color}}></span><span className={`font-bold text-lg block ${item.bought?'line-through':''}`}>{item.name}</span></div><span className="text-xs opacity-60">{item.price ? `Â¥${item.price}` : ''} {item.note ? ` â€¢ ${item.note}` : ''}</span></div></div><div className="flex gap-2">{item.bought && <button onClick={() => convertToExpense(item)} className="text-xs bg-[#FF69B4] text-white px-2 py-1 rounded-full">è¨˜å¸³</button>}<button onClick={() => deleteItem(item.id)} className="text-gray-300 hover:text-red-400"><Icons.Trash size={16}/></button></div></div>))}</div></div></div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
