<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <!-- PWA 設定: 讓網頁變身 App -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="班級小管家">
    <meta name="format-detection" content="telephone=no">

    <!-- 內嵌 App Icon (黃色筆記本風格) -->
    <link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect width='100' height='100' rx='22' fill='%23F6E05E'/%3E%3Cpath d='M30 25h40M30 40h40M30 55h25' stroke='%2378350F' stroke-width='6' stroke-linecap='round'/%3E%3Ccircle cx='75' cy='70' r='12' fill='%23F87171'/%3E%3Cpath d='M75 64v12m-6-6h12' stroke='white' stroke-width='3' stroke-linecap='round'/%3E%3C/svg%3E">
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect width='100' height='100' rx='22' fill='%23F6E05E'/%3E%3Cpath d='M30 25h40M30 40h40M30 55h25' stroke='%2378350F' stroke-width='6' stroke-linecap='round'/%3E%3Ccircle cx='75' cy='70' r='12' fill='%23F87171'/%3E%3Cpath d='M75 64v12m-6-6h12' stroke='white' stroke-width='3' stroke-linecap='round'/%3E%3C/svg%3E">

    <title>班級小管家 Pro</title>

    <!-- 載入核心庫 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide-react@latest/dist/umd/lucide-react.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&family=ZCOOL+KuaiLe&display=swap" rel="stylesheet">

    <style>
        /* iOS App 級別優化 CSS */
        :root {
            --sat: env(safe-area-inset-top);
            --sab: env(safe-area-inset-bottom);
        }
        body {
            background-color: #FEF9F2;
            background-image: radial-gradient(#E5E7EB 1px, transparent 1px);
            background-size: 20px 20px;
            font-family: 'ZCOOL KuaiLe', 'Noto Sans TC', sans-serif;
            color: #4B2C20; /* 深咖啡色 */
            -webkit-user-select: none; /* 禁止選取文字 */
            user-select: none;
            -webkit-tap-highlight-color: transparent;
            overscroll-behavior-y: none; /* 禁止橡皮筋效果 */
            position: fixed; /* 固定全螢幕 */
            top: 0; left: 0; right: 0; bottom: 0;
            padding-top: var(--sat);
            padding-bottom: var(--sab);
        }
        #root {
            height: 100%;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            display: flex;
            flex-direction: column;
        }
        
        /* 3D 按鈕 */
        .btn-3d {
            transition: all 0.1s;
            border-bottom: 4px solid rgba(0,0,0,0.2);
            active: border-bottom-width: 0;
            transform: translateY(0);
        }
        .btn-3d:active {
            transform: translateY(2px);
            border-bottom: 2px solid rgba(0,0,0,0.2);
        }

        /* 輸入框優化 */
        .input-ios {
            font-size: 1.1rem; /* 防止 iOS 自動縮放 */
            background: #FFF;
            border: 2px solid #E5E7EB;
            border-radius: 12px;
            padding: 12px;
            width: 100%;
            outline: none;
            -webkit-user-select: text;
            user-select: text;
        }
        .input-ios:focus { border-color: #FCD34D; }

        /* 隱藏捲軸 */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;
        const { 
            User, Users, Clock, BookOpen, AlertCircle, CheckCircle2, MessageCircle, 
            MicOff, Coffee, FileWarning, Edit3, Trash2, Plus, X, Briefcase, Stethoscope, 
            Palmtree, HelpCircle, Star, PackageX, ClipboardCopy, Download, Settings, 
            FileSpreadsheet, List, UserCog, Share, LayoutGrid, Info, PenTool, AlertTriangle, 
            Megaphone, Send, Tablet, Smartphone, Save
        } = window.lucideReact;

        // --- 核心資料結構 ---
        const DB_KEY = 'classManager_Pro_DB'; // 本地資料庫金鑰
        
        const PERIODS = [
            { id: 'early', label: '早修' }, { id: 'p1', label: '第一節' }, { id: 'p2', label: '第二節' },
            { id: 'p3', label: '第三節' }, { id: 'p4', label: '第四節' }, { id: 'lunch', label: '午餐' },
            { id: 'nap', label: '午休' }, { id: 'p5', label: '第五節' }, { id: 'p6', label: '第六節' },
            { id: 'p7', label: '第七節' }, { id: 'p8', label: '第八節' }
        ];

        const DEFAULT_BEHAVIORS = [
            { id: 'item_missing', label: '物品未帶', icon: 'PackageX', color: 'bg-pink-200' },
            { id: 'late_class', label: '晚進教室', icon: 'Clock', color: 'bg-yellow-200' },
            { id: 'chat', label: '聊天干擾', icon: 'MessageCircle', color: 'bg-yellow-200' },
            { id: 'sleep', label: '打瞌睡', icon: 'Coffee', color: 'bg-pink-200' },
            { id: 'no_hw', label: '作業未交', icon: 'FileWarning', color: 'bg-red-200' },
            { id: 'other', label: '其他', icon: 'PenTool', color: 'bg-blue-200' }
        ];

        const ATTENDANCE_TYPES = [
            { id: 'late', label: '遲到', icon: Clock, color: 'bg-yellow-100' },
            { id: 'sick', label: '病假', icon: Stethoscope, color: 'bg-green-100' },
            { id: 'official', label: '公假', icon: Briefcase, color: 'bg-blue-100' },
            { id: 'personal', label: '事假', icon: Palmtree, color: 'bg-purple-100' },
            { id: 'absent', label: '缺席', icon: AlertCircle, color: 'bg-red-100' }
        ];

        const CONTACT_BOOK_TYPES = [
            { id: 'cb_missing', label: '聯絡簿缺交', icon: X, color: 'bg-red-100' },
            { id: 'cb_good', label: '聯絡簿優良', icon: Star, color: 'bg-green-100' }
        ];

        const ICON_MAP = { PackageX, Clock, MicOff, AlertCircle, MessageCircle, FileWarning, BookOpen, Coffee, HelpCircle, PenTool };

        // --- App Component ---
        function App() {
            const [activeTab, setActiveTab] = useState('basic');
            const scrollRef = useRef(null);

            // 1. 日期狀態
            const [currentDate, setCurrentDate] = useState(() => {
                const now = new Date();
                const offset = now.getTimezoneOffset() * 60000;
                return new Date(now.getTime() - offset).toISOString().split('T')[0];
            });

            // 2. 全局數據 (從 LocalStorage 讀取)
            const [allData, setAllData] = useState(() => {
                try {
                    const saved = localStorage.getItem(DB_KEY);
                    return saved ? JSON.parse(saved) : {};
                } catch (e) { console.error("Load Error", e); return {}; }
            });

            // 3. 當日數據 (Derived State)
            const [week, setWeek] = useState('');
            const [dutyOfficer, setDutyOfficer] = useState('');
            const [dutyStudent, setDutyStudent] = useState('');
            const [attendanceData, setAttendanceData] = useState({});
            const [missingData, setMissingData] = useState({});
            const [classLogData, setClassLogData] = useState({});
            const [periodNotes, setPeriodNotes] = useState({});
            const [incidentLog, setIncidentLog] = useState('');

            // 4. 設定數據
            const [students, setStudents] = useState(() => {
                try { return JSON.parse(localStorage.getItem('cm_students')) || Array.from({length:30},(_,i)=>({id:i+1,name:`${i+1}號`})); } catch { return []; }
            });
            const [subjects, setSubjects] = useState(() => {
                try { return JSON.parse(localStorage.getItem('cm_subjects')) || [{id:'chi',label:'國文'},{id:'eng',label:'英文'},{id:'math',label:'數學'}]; } catch { return []; }
            });
            const [behaviors, setBehaviors] = useState(() => {
                try { return JSON.parse(localStorage.getItem('cm_behaviors')) || DEFAULT_BEHAVIORS; } catch { return DEFAULT_BEHAVIORS; }
            });

            // 5. UI 狀態
            const [selectorConfig, setSelectorConfig] = useState({ open: false, type: '', category: '', period: '' });
            const [teacherNote, setTeacherNote] = useState(() => localStorage.getItem('cm_teacherNote') || '');
            const [currentLogPeriod, setCurrentLogPeriod] = useState('p1');
            const [bulkNames, setBulkNames] = useState('');
            const [newSubName, setNewSubName] = useState('');
            const [selectedReportStudent, setSelectedReportStudent] = useState(1);
            
            // --- 核心邏輯: 讀取當日數據 ---
            useEffect(() => {
                const day = allData[currentDate] || {};
                setWeek(day.week || '');
                setDutyOfficer(day.dutyOfficer || '');
                setDutyStudent(day.dutyStudent || '');
                setAttendanceData(day.attendanceData || {});
                setMissingData(day.missingData || {});
                setClassLogData(day.classLogData || {});
                setPeriodNotes(day.periodNotes || {});
                setIncidentLog(day.incidentLog || '');
            }, [currentDate, allData]);

            // --- 核心邏輯: 自動存檔 (Debounce) ---
            useEffect(() => {
                const handler = setTimeout(() => {
                    setAllData(prev => {
                        const newData = {
                            ...prev,
                            [currentDate]: {
                                week, dutyOfficer, dutyStudent,
                                attendanceData, missingData, classLogData,
                                periodNotes, incidentLog
                            }
                        };
                        localStorage.setItem(DB_KEY, JSON.stringify(newData));
                        return newData;
                    });
                }, 800); // 延遲 0.8秒 寫入，提升效能
                return () => clearTimeout(handler);
            }, [week, dutyOfficer, dutyStudent, attendanceData, missingData, classLogData, periodNotes, incidentLog]);

            // --- 設定存檔 ---
            useEffect(() => { localStorage.setItem('cm_students', JSON.stringify(students)); }, [students]);
            useEffect(() => { localStorage.setItem('cm_subjects', JSON.stringify(subjects)); }, [subjects]);
            useEffect(() => { localStorage.setItem('cm_behaviors', JSON.stringify(behaviors)); }, [behaviors]);
            useEffect(() => { localStorage.setItem('cm_teacherNote', teacherNote); }, [teacherNote]);
            useEffect(() => { if(scrollRef.current) scrollRef.current.scrollTop = 0; }, [activeTab]);

            // --- 操作函數 ---
            const toggleStudent = (sId) => {
                const { type, category, period } = selectorConfig;
                if(type === 'att') {
                    setAttendanceData(prev => {
                        const list = prev[category] || [];
                        return { ...prev, [category]: list.includes(sId) ? list.filter(id=>id!==sId) : [...list, sId] };
                    });
                } else if (type === 'miss') {
                    setMissingData(prev => {
                        const list = prev[category] || [];
                        return { ...prev, [category]: list.includes(sId) ? list.filter(id=>id!==sId) : [...list, sId] };
                    });
                } else if (type === 'log') {
                    setClassLogData(prev => {
                        const periodData = prev[period] || {};
                        const list = periodData[category] || [];
                        return { ...prev, [period]: { ...periodData, [category]: list.includes(sId) ? list.filter(id=>id!==sId) : [...list, sId] } };
                    });
                }
            };

            const getSelectedList = () => {
                const { type, category, period } = selectorConfig;
                if(type === 'att') return attendanceData[category] || [];
                if(type === 'miss') return missingData[category] || [];
                if(type === 'log') return classLogData[period]?.[category] || [];
                return [];
            };

            const handleImportNames = () => {
                const lines = bulkNames.split('\n').map(x=>x.trim()).filter(x=>x);
                if(lines.length && confirm(`確定匯入 ${lines.length} 位學生？舊名單將被覆蓋。`)) {
                    setStudents(lines.map((n,i) => ({id: i+1, name: n})));
                    alert('匯入完成');
                    setBulkNames('');
                }
            };

            const handleAddSubject = () => {
                if(newSubName) {
                    setSubjects([...subjects, {id: `s_${Date.now()}`, label: newSubName}]);
                    setNewSubName('');
                }
            };

            // --- 報表邏輯 ---
            const getStats = (sid) => {
                // 統計近5日
                const dates = [];
                const d = new Date(currentDate);
                for(let i=0; i<5; i++) {
                    dates.push(new Date(d).toISOString().split('T')[0]);
                    d.setDate(d.getDate() - 1);
                }
                
                let count = { att: 0, miss: 0, beh: 0 };
                let details = [];

                dates.forEach(dateStr => {
                    const data = allData[dateStr];
                    if(!data) return;
                    // 缺勤
                    if(data.attendanceData) Object.values(data.attendanceData).forEach(arr => { if(arr?.includes(sid)) count.att++; });
                    // 缺交
                    if(data.missingData) Object.values(data.missingData).forEach(arr => { if(arr?.includes(sid)) count.miss++; });
                    // 違規
                    if(data.classLogData) {
                        Object.entries(data.classLogData).forEach(([pid, pLog]) => {
                            Object.entries(pLog).forEach(([bid, arr]) => {
                                if(arr?.includes(sid)) {
                                    count.beh++;
                                    const bName = behaviors.find(b=>b.id===bid)?.label || '其他';
                                    const pName = PERIODS.find(p=>p.id===pid)?.label || pid;
                                    details.push(`${dateStr.slice(5)} ${pName}:${bName}`);
                                }
                            });
                        });
                    }
                });
                return { count, details };
            };

            // --- 匯出 CSV ---
            const exportDaily = () => {
                let csv = `\uFEFF日期,${currentDate},週次,${week},值日,${dutyOfficer}/${dutyStudent}\n\n【考勤】\n`;
                ATTENDANCE_TYPES.forEach(t => {
                    const names = (attendanceData[t.id]||[]).map(id=>students.find(s=>s.id===id)?.name).join(' ');
                    if(names) csv += `${t.label},${names}\n`;
                });
                csv += `\n【缺交】\n`;
                [...CONTACT_BOOK_TYPES, ...subjects].forEach(t => {
                    const names = (missingData[t.id]||[]).map(id=>students.find(s=>s.id===id)?.name).join(' ');
                    if(names) csv += `${t.label},${names}\n`;
                });
                csv += `\n【課堂】\n`;
                PERIODS.forEach(p => {
                    const note = periodNotes[p.id] || '';
                    let hasLog = false;
                    behaviors.forEach(b => {
                        const list = classLogData[p.id]?.[b.id] || [];
                        if(list.length) {
                            hasLog = true;
                            csv += `${p.label},${b.label},${list.map(id=>students.find(s=>s.id===id)?.name).join(' ')}\n`;
                        }
                    });
                    if(note) csv += `${p.label},備註,${note}\n`;
                });
                const blob = new Blob([csv], {type:'text/csv;charset=utf-8'});
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = `日誌_${currentDate}.csv`;
                link.click();
            };

            // --- 介面渲染區 ---
            // 1. 學生選擇器 Modal
            const SelectorModal = () => {
                if(!selectorConfig.open) return null;
                const { type, category, period } = selectorConfig;
                const selected = getSelectedList();
                let title = '';
                if(type === 'att') title = ATTENDANCE_TYPES.find(x=>x.id===category)?.label;
                if(type === 'miss') title = [...CONTACT_BOOK_TYPES, ...subjects].find(x=>x.id===category)?.label + ' 缺交';
                if(type === 'log') title = `${PERIODS.find(x=>x.id===period)?.label} ${behaviors.find(x=>x.id===category)?.label}`;

                return (
                    <div className="fixed inset-0 z-50 bg-black/60 backdrop-blur-sm flex items-end md:items-center justify-center animate-in fade-in duration-200">
                        <div className="bg-[#FEF9F2] w-full md:w-[480px] h-[85vh] md:h-[600px] rounded-t-2xl md:rounded-2xl flex flex-col shadow-2xl">
                            <div className="p-4 border-b-2 border-orange-100 flex justify-between items-center bg-yellow-50 rounded-t-2xl">
                                <div>
                                    <h3 className="text-xl font-bold text-gray-800">點選學生</h3>
                                    <p className="text-sm text-orange-600 font-bold">{title}</p>
                                </div>
                                <button onClick={()=>setSelectorConfig({...selectorConfig, open:false})} className="p-2 bg-white rounded-full shadow-sm"><X/></button>
                            </div>
                            <div className="flex-1 overflow-y-auto p-4 grid grid-cols-4 md:grid-cols-5 gap-3 content-start">
                                {students.map(s => (
                                    <button key={s.id} onClick={()=>toggleStudent(s.id)}
                                        className={`p-2 rounded-xl border-2 transition-all flex flex-col items-center justify-center min-h-[64px]
                                            ${selected.includes(s.id) ? 'bg-orange-500 border-orange-600 text-white shadow-lg scale-105' : 'bg-white border-orange-100 text-gray-700 hover:bg-orange-50'}`}>
                                        <span className="text-xs opacity-75">{s.id}</span>
                                        <span className="font-bold">{s.name}</span>
                                    </button>
                                ))}
                            </div>
                            <div className="p-4 border-t border-orange-100 bg-white rounded-b-2xl">
                                <button onClick={()=>setSelectorConfig({...selectorConfig, open:false})} className="w-full btn-3d bg-green-400 text-white py-3 rounded-xl font-bold text-xl">完成 ({selected.length})</button>
                            </div>
                        </div>
                    </div>
                );
            };

            // 2. 畫面: 點名 (Basic)
            const renderBasic = () => (
                <div className="space-y-6 pb-32">
                    {/* 日期卡片 */}
                    <div className="bg-white p-4 rounded-2xl shadow-sm border border-orange-100 flex flex-col gap-3">
                        <div className="flex gap-2">
                            <div className="flex-1">
                                <label className="text-xs font-bold text-gray-500 mb-1 block">日期</label>
                                <input type="date" value={currentDate} onChange={e=>setCurrentDate(e.target.value)} className="input-ios" />
                            </div>
                            <div className="w-1/3">
                                <label className="text-xs font-bold text-gray-500 mb-1 block">週次</label>
                                <input type="number" value={week} onChange={e=>setWeek(e.target.value)} className="input-ios text-center" />
                            </div>
                        </div>
                        <div className="flex gap-2">
                            <input placeholder="值日幹部" value={dutyOfficer} onChange={e=>setDutyOfficer(e.target.value)} className="input-ios" />
                            <input placeholder="值日生" value={dutyStudent} onChange={e=>setDutyStudent(e.target.value)} className="input-ios" />
                        </div>
                    </div>

                    {/* 考勤卡片 */}
                    <div className="bg-white rounded-2xl shadow-sm border border-orange-100 overflow-hidden">
                        <div className="bg-orange-100 px-4 py-2 font-bold text-orange-800 flex items-center gap-2"><Clock size={18}/> 考勤</div>
                        <div className="p-4 grid grid-cols-2 gap-3">
                            {ATTENDANCE_TYPES.map(t => {
                                const count = attendanceData[t.id]?.length || 0;
                                return (
                                    <button key={t.id} onClick={()=>setSelectorConfig({open:true, type:'att', category:t.id})}
                                        className={`btn-3d p-3 rounded-xl flex items-center justify-between ${t.color}`}>
                                        <span className="font-bold text-gray-700">{t.label}</span>
                                        {count > 0 && <span className="bg-white px-2 py-0.5 rounded-full text-sm font-bold shadow-sm">{count}</span>}
                                    </button>
                                );
                            })}
                        </div>
                    </div>

                    {/* 缺交卡片 */}
                    <div className="bg-white rounded-2xl shadow-sm border border-orange-100 overflow-hidden">
                        <div className="bg-red-100 px-4 py-2 font-bold text-red-800 flex items-center gap-2"><FileWarning size={18}/> 缺交登記</div>
                        <div className="p-4 space-y-4">
                            <div className="grid grid-cols-2 gap-3">
                                {CONTACT_BOOK_TYPES.map(t => (
                                    <button key={t.id} onClick={()=>setSelectorConfig({open:true, type:'miss', category:t.id})}
                                        className={`btn-3d p-3 rounded-xl flex justify-between ${t.color}`}>
                                        <span className="font-bold">{t.label}</span>
                                        <span className="bg-white/50 px-2 rounded text-sm">{missingData[t.id]?.length||0}</span>
                                    </button>
                                ))}
                            </div>
                            <div className="border-t border-dashed border-gray-200 pt-3">
                                <p className="text-xs font-bold text-gray-400 mb-2">科目作業</p>
                                <div className="flex flex-wrap gap-2">
                                    {subjects.map(s => (
                                        <button key={s.id} onClick={()=>setSelectorConfig({open:true, type:'miss', category:s.id})}
                                            className="px-3 py-2 bg-gray-50 border border-gray-200 rounded-lg text-gray-700 font-bold flex items-center gap-2 active:bg-gray-200 transition">
                                            {s.label}
                                            {(missingData[s.id]?.length > 0) && <span className="bg-red-500 text-white px-1.5 rounded text-xs">{missingData[s.id].length}</span>}
                                        </button>
                                    ))}
                                    <button onClick={()=>setActiveTab('settings')} className="px-3 py-2 bg-gray-100 rounded-lg text-gray-400"><Plus size={18}/></button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );

            // 3. 畫面: 課堂紀錄 (Log)
            const renderLog = () => (
                <div className="space-y-4 pb-32">
                    <div className="bg-white p-3 rounded-2xl shadow-sm border border-orange-100 flex items-center gap-2 sticky top-0 z-10">
                        <Clock className="text-orange-500"/>
                        <select value={currentLogPeriod} onChange={e=>setCurrentLogPeriod(e.target.value)} className="flex-1 bg-transparent text-xl font-bold outline-none text-gray-800">
                            {PERIODS.map(p=><option key={p.id} value={p.id}>{p.label}</option>)}
                        </select>
                    </div>

                    <div className="bg-white p-4 rounded-2xl shadow-sm border border-orange-100">
                        <div className="grid grid-cols-3 gap-3 mb-4">
                            {behaviors.map(b => {
                                const count = classLogData[currentLogPeriod]?.[b.id]?.length || 0;
                                const Icon = ICON_MAP[b.icon] || AlertCircle;
                                return (
                                    <button key={b.id} onClick={()=>setSelectorConfig({open:true, type:'log', category:b.id, period:currentLogPeriod})}
                                        className={`btn-3d flex flex-col items-center justify-center p-2 h-24 rounded-xl gap-1 relative ${b.color}`}>
                                        <Icon size={24} className="opacity-70"/>
                                        <span className="text-sm font-bold leading-tight">{b.label}</span>
                                        {count > 0 && <span className="absolute top-1 right-1 bg-red-500 text-white text-xs w-5 h-5 flex items-center justify-center rounded-full shadow">{count}</span>}
                                    </button>
                                );
                            })}
                        </div>
                        <input type="text" placeholder="該節備註..." 
                            value={periodNotes[currentLogPeriod]||''} 
                            onChange={e=>setPeriodNotes({...periodNotes, [currentLogPeriod]:e.target.value})}
                            className="input-ios bg-gray-50 border-0" />
                    </div>

                    <div className="bg-white p-4 rounded-2xl shadow-sm border border-orange-100">
                        <h4 className="font-bold text-gray-500 mb-2">當日紀錄預覽</h4>
                        <div className="text-sm space-y-2 text-gray-600">
                            {behaviors.map(b => {
                                const list = classLogData[currentLogPeriod]?.[b.id];
                                if(!list?.length) return null;
                                return <div key={b.id}><span className="font-bold text-orange-600">{b.label}:</span> {list.map(id=>students.find(s=>s.id===id)?.name).join(' ')}</div>
                            })}
                            {!Object.keys(classLogData[currentLogPeriod]||{}).length && <span className="text-gray-300">尚無紀錄</span>}
                        </div>
                    </div>
                </div>
            );

            // 4. 畫面: 報表 (Report)
            const renderReport = () => {
                const s = students.find(x=>x.id===selectedReportStudent);
                const { count, details } = getStats(selectedReportStudent);
                return (
                    <div className="space-y-4 pb-32">
                         <div className="bg-yellow-50 p-4 rounded-2xl border border-yellow-200">
                            <h3 className="font-bold text-yellow-800 mb-2">學生個案分析 (近5日)</h3>
                            <select value={selectedReportStudent} onChange={e=>setSelectedReportStudent(Number(e.target.value))} className="input-ios mb-4">
                                {students.map(s=><option key={s.id} value={s.id}>{s.id}. {s.name}</option>)}
                            </select>
                            <div className="flex gap-2 mb-4">
                                <div className="flex-1 bg-white p-3 rounded-xl text-center"><div className="text-2xl font-bold text-gray-800">{count.att}</div><div className="text-xs text-gray-400">缺勤</div></div>
                                <div className="flex-1 bg-white p-3 rounded-xl text-center"><div className="text-2xl font-bold text-red-500">{count.miss}</div><div className="text-xs text-gray-400">缺交</div></div>
                                <div className="flex-1 bg-white p-3 rounded-xl text-center"><div className="text-2xl font-bold text-orange-500">{count.beh}</div><div className="text-xs text-gray-400">違規</div></div>
                            </div>
                            <div className="bg-white p-3 rounded-xl min-h-[100px] text-sm text-gray-600 mb-4">
                                {details.length ? details.map((d,i)=><div key={i}>• {d}</div>) : <div className="text-gray-300 text-center py-4">近期表現良好</div>}
                            </div>
                            <button onClick={()=>{
                                const msg = `${s.name} 家長您好，本週在校狀況：\n缺勤${count.att}次，缺交${count.miss}項，違規${count.beh}次。\n${details.join('\n')}`;
                                navigator.clipboard.writeText(msg).then(()=>alert('已複製通知文字'));
                            }} className="btn-3d w-full bg-green-500 text-white py-3 rounded-xl font-bold">複製家長通知</button>
                        </div>
                        <button onClick={exportDaily} className="btn-3d w-full bg-blue-500 text-white py-4 rounded-xl font-bold text-lg flex items-center justify-center gap-2">
                            <Download/> 下載今日日誌 (Excel)
                        </button>
                    </div>
                );
            };

            // 5. 畫面: 設定 (Settings)
            const renderSettings = () => (
                <div className="space-y-6 pb-32">
                    <div className="bg-white p-4 rounded-2xl shadow-sm">
                        <h3 className="font-bold mb-4 flex items-center gap-2"><UserCog/> 學生名單管理</h3>
                        <textarea className="input-ios h-32 mb-2" placeholder="一行一個名字..." value={bulkNames} onChange={e=>setBulkNames(e.target.value)}></textarea>
                        <button onClick={handleImportNames} className="btn-3d bg-gray-800 text-white px-4 py-2 rounded-lg text-sm w-full">匯入名單 (會覆蓋舊資料)</button>
                    </div>
                    <div className="bg-white p-4 rounded-2xl shadow-sm">
                        <h3 className="font-bold mb-4 flex items-center gap-2"><BookOpen/> 科目管理</h3>
                        <div className="flex gap-2 mb-4">
                            <input className="input-ios" placeholder="新科目" value={newSubName} onChange={e=>setNewSubName(e.target.value)}/>
                            <button onClick={handleAddSubject} className="bg-green-500 text-white px-4 rounded-lg font-bold">新增</button>
                        </div>
                        <div className="flex flex-wrap gap-2">
                            {subjects.map(s => (
                                <div key={s.id} className="bg-gray-100 px-3 py-1 rounded-full text-sm flex items-center gap-2">
                                    {s.label}
                                    <button onClick={()=>{if(confirm('刪除?')) setSubjects(subjects.filter(x=>x.id!==s.id))}} className="text-gray-400"><X size={14}/></button>
                                </div>
                            ))}
                        </div>
                    </div>
                    <div className="bg-orange-50 p-4 rounded-2xl text-sm text-orange-800">
                        <p className="font-bold mb-1">關於本地儲存</p>
                        <p>資料皆儲存在您的手機/平板中 (Local Storage)，不會上傳雲端。請勿清除 Safari 網站資料，否則資料會消失。建議每週五匯出 Excel 備份。</p>
                    </div>
                </div>
            );

            return (
                <div className="w-full md:max-w-4xl mx-auto h-full flex flex-col">
                    {/* Header */}
                    <header className="px-5 pt-4 pb-2 bg-[#FEF9F2] shrink-0">
                        <div className="flex justify-between items-center">
                            <h1 className="text-3xl font-black text-[#4B2C20] tracking-wider flex items-center gap-2">
                                <span className="bg-[#F6E05E] px-2 rounded-lg transform -rotate-2 inline-block shadow-sm">班級</span>
                                小管家
                            </h1>
                            <div className="text-xs font-bold text-gray-400 border border-gray-200 px-2 py-1 rounded-full">Pro v2.0</div>
                        </div>
                    </header>

                    {/* Main Content */}
                    <main className="flex-1 overflow-y-auto px-5 pt-2" ref={scrollRef}>
                        {activeTab === 'basic' && renderBasic()}
                        {activeTab === 'log' && renderLog()}
                        {activeTab === 'report' && renderReport()}
                        {activeTab === 'settings' && renderSettings()}
                    </main>

                    {/* Modal */}
                    <SelectorModal />

                    {/* Tab Bar */}
                    <nav className="fixed bottom-6 left-4 right-4 md:left-1/2 md:-translate-x-1/2 md:w-[480px] bg-white/90 backdrop-blur-md border border-gray-200 rounded-3xl shadow-xl p-2 flex justify-between items-end z-40">
                        {[
                            {id:'basic', icon:User, label:'點名'},
                            {id:'log', icon:Edit3, label:'紀錄'},
                            {id:'report', icon:FileSpreadsheet, label:'報表'},
                            {id:'settings', icon:Settings, label:'設定'}
                        ].map(tab => {
                            const isActive = activeTab === tab.id;
                            return (
                                <button key={tab.id} onClick={()=>setActiveTab(tab.id)}
                                    className={`flex-1 flex flex-col items-center gap-1 py-2 transition-all duration-300 ${isActive ? '-translate-y-3' : 'opacity-50'}`}>
                                    <div className={`p-3 rounded-full shadow-sm transition-all ${isActive ? 'bg-[#4B2C20] text-white scale-110' : 'bg-transparent text-gray-600'}`}>
                                        <tab.icon size={24} strokeWidth={isActive?3:2}/>
                                    </div>
                                    {isActive && <span className="text-[10px] font-bold text-[#4B2C20]">{tab.label}</span>}
                                </button>
                            )
                        })}
                    </nav>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
